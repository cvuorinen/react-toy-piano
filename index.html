<html>
    <head>
        <title>Piano</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <script src="https://npmcdn.com/tone@0.6.1/build/Tone.min.js"></script>
        <script src="https://npmcdn.com/react-towel@2/umd/react-towel.js"></script>
        <script src="https://code.jquery.com/pep/0.4.1/pep.js"></script>
        <script type="text/babel">
            class App extends React.Component {
                constructor(props) {
                    super(props)
                    this.songs = [
                        { name: '\u2605 Twinkle', score: [
                            ['C4,4', 'C4,4', 'G4,4', 'G4,4', 'A4,4', 'A4,4', 'G4,2'],
                            ['F4,4', 'F4,4', 'E4,4', 'E4,4', 'D4,4', 'D4,4', 'C4,2'],
                            ['G4,4', 'G4,4', 'F4,4', 'F4,4', 'E4,4', 'E4,4', 'D4,2'],
                            ['G4,4', 'G4,4', 'F4,4', 'F4,4', 'E4,4', 'E4,4', 'D4,2'],
                            ['C4,4', 'C4,4', 'G4,4', 'G4,4', 'A4,4', 'A4,4', 'G4,2'],
                            ['F4,4', 'F4,4', 'E4,4', 'E4,4', 'D4,4', 'D4,4', 'C4,2'],
                        ]},
                        { name: '\uD83D\uDEB6 Noa', score: [
                            ['C4,4', 'C4,4', 'C4,4', 'E4,4', 'D4,4', 'D4,4', 'D4,4', 'F4,4'],
                            ['E4,4', 'E4,4', 'D4,4', 'D4,4', 'C4,2'],
                            ['E4,4', 'E4,4', 'E4,4', 'E4,4', 'G4,2', 'F4,2'],
                            ['D4,4', 'D4,4', 'D4,4', 'D4,4', 'F4,2', 'E4,2'],
                            ['C4,4', 'C4,4', 'C4,4', 'E4,4', 'D4,4', 'D4,4', 'D4,4', 'F4,4'],
                            ['E4,4', 'E4,4', 'D4,4', 'D4,4', 'C4,2'],
                        ]},
                        { name: '\uD83C\uDF82 Birthday', score: [
                            ['D4,8', 'D4,8', 'E4,4', 'D4,4', 'G4,4', 'F4,2'],
                            ['D4,8', 'D4,8', 'E4,4', 'D4,4', 'A4,4', 'G4,2'],
                            ['D4,8', 'D4,8', 'D5,4', 'B4,4', 'G4,4', 'F4,4', 'E4,4'],
                            ['C5,8', 'C5,8', 'B4,4', 'G4,4', 'A4,4', 'G4,2'],
                        ]},
                        { name: '\u266B Do-Re-Mi', score: [
                            ['C4,4', 'D4,4', 'E4,4', 'F4,4', 'G4,4', 'A4,4'],
                            ['B4,4', 'C5,4', 'D5,4', 'E5,4', 'F5,4', 'G5,4'],
                            ['G5,4', 'F5,4', 'E5,4', 'D5,4', 'C5,4', 'B4,4'],
                            ['A4,4', 'G4,4', 'F4,4', 'E4,4', 'D4,4', 'C4,4'],
                        ]}
                    ]
                    this.colorSchemes = [
                        'basic', 'plain'
                    ]

                    this.state = {
                        song: this.songs[0],
                        color: this.colorSchemes[0]
                    }
                }
                nextSong() {
                    const currentIndex = this.songs.indexOf(this.state.song)
                    const next = currentIndex + 1 < this.songs.length
                        ? currentIndex + 1
                        : 0;
                    this.setState({ song: this.songs[next], color: this.state.color })
                }
                selectColor(newColor) {
                    this.setState({ song: this.state.song, color: newColor })
                }
                render() {
                    return <container className={'color-' + this.state.color}>
                            <Score song={this.state.song} onNextSong={this.nextSong.bind(this)} />
                            <Settings song={this.state.song} onNextSong={this.nextSong.bind(this)}
                                      colorSchemes={this.colorSchemes} onSelectColor={this.selectColor.bind(this)} />
                            <Piano />
                        </container>
                }
            }

            class Settings extends React.Component {
                render() {
                    let selectColor = (color) => () => this.props.onSelectColor(color)
                    let colorList = this.props.colorSchemes.map(color =>
                        <div className={'color-' + color} onClick={selectColor(color)}></div>
                    )
                    return <div className="settings">
                            <div onClick={this.props.onNextSong}>Song: <span className="song">{this.props.song.name}</span></div>
                            <div className="color-select">Color: {colorList}</div>
                        </div>
                }
            }

            class Score extends React.Component {
                getNoteClassName(noteWithTime) {
                    let note, time;
                    [note, time] = noteWithTime.split(',')
                    let classes = ['note', note, note[0], 't' + time]

                    return classes.join(' ')
                }
                render() {
                    let clef = <note><span className="note clef" /></note>
                    let scoreList = this.props.song.score.map((score, index) =>
                        <div className="score" onClick={this.props.onNextSong}>
                            {(index === 0) ? clef : null}
                            {score.map(note =>
                                <note><span className={this.getNoteClassName(note)}/></note>
                            )}
                        </div>
                    )

                    return <div className="sheet">{scoreList}</div>
                }
            }

            class Piano extends React.Component {
                constructor(props) {
                    super(props)
                    this.synth = new Tone.SimpleSynth().toMaster()
                }
                play(note) {
                    this.synth.triggerAttack(note)
                }
                release() {
                    this.synth.triggerRelease()
                }
                render() {
                    let keys = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5', 'D5', 'E5', 'F5', 'G5']
                    let keyList = keys.map(key =>
                        <Key onPress={this.play.bind(this)} onRelease={this.release.bind(this)} note={key} />
                    )

                    return <div className="piano"
                                ref={node => node && node.setAttribute('touch-action', 'none')}>
                                {keyList}
                            </div>
                }
            }

            const Key = React.createClass({
                getInitialState: function () {
                    return { pressed: false }
                },
                componentDidMount: function() {
                    /**
                     * Use PEP (Pointer Events Polyfill) to detect touches that move accross dom elements.
                     * (requires that a touch-action attribute is present in html to activate it)
                     */
                    ReactDOM.findDOMNode(this).addEventListener('pointerdown', this.press)
                    ReactDOM.findDOMNode(this).addEventListener('pointerup', this.release)
                    ReactDOM.findDOMNode(this).addEventListener('pointerenter', this.press)
                    ReactDOM.findDOMNode(this).addEventListener('pointerleave', this.release)
                    ReactDOM.findDOMNode(this).addEventListener('pointercancel', this.release)
                },
                press: function (e) {
                    // When not on touch device, filter out events when mouse button not pressed
                    const isTouchDevice = 'ontouchstart' in window.document.documentElement;
                    if (this.state.pressed || (!isTouchDevice && e.buttons !== 1)) {
                        return
                    }
                    this.setState({ pressed: true })
                    this.props.onPress(this.props.note)
                },
                release: function () {
                    this.setState({ pressed: false })
                    this.props.onRelease(this.props.note)
                },
                getClassName: function () {
                    let classes = ['key', this.props.note[0], 'o' + this.props.note[1]]
                    if (this.state.pressed) {
                        classes.push('down')
                    }
                    return classes.join(' ')
                },
                render: function () {
                    return <a className={this.getClassName()}><span/></a>
                }
            });

            ReactDOM.render(
                <App />,
                document.getElementById('root')
            )
        </script>
        <style type="text/css">
            @import url(http://fonts.googleapis.com/css?family=Open+Sans);
            @font-face { font-family: FreeSerif; src: url(FreeSerif.woff); }
            html, body { height: 100%; margin: 0; font-family: "Open Sans",sans-serif; }
            container { height: 100%; display: flex; flex-direction: column; }
            container > .sheet { flex: 1 calc(60% - 15px); }
            container > .settings { flex: 1 30px; }
            container > .piano { flex: 1 calc(40% - 15px); }

            .settings { background: #444; color: #fff; line-height: 30px; padding: 0 3vw;
                display: flex; flex-direction: row; }
            .settings > * { flex: 1 100%; }
            .settings .song { font-family: FreeSerif; }
            .settings .color-select { text-align: right; }
            .settings .color-select > div { display: inline-block; width: 20px; height: 20px;
                margin: 2px 4px 0 4px; vertical-align: sub; border-radius: 4px; background: white; }

            .piano { display: flex; flex-direction: row; padding: 2vh; background: #222; }
            .piano > * { flex: 1 100%; display: block; }
            .key {
                position: relative;
                display: block;
                background: white;
                border: 2px solid #333;
                border-top: none;
                border-radius: 1vw;
                border-bottom-right-radius: 2vw;
                border-bottom-left-radius: 2vw;
                margin-bottom: 1vh;
            }
            .key span { position: absolute; bottom: 2vh; left: 0; right: 0;
                text-align: center; font-size: 3vw;
                font-weight: bold; color: #333;
            }
            .key.down { margin-bottom: 0; box-shadow: inset 0 -3vh 7vw rgba(0, 0, 0, 0.2); }
            .key.C span:after { content: "C"; }
            .key.D span:after { content: "D"; }
            .key.E span:after { content: "E"; }
            .key.F span:after { content: "F"; }
            .key.G span:after { content: "G"; }
            .key.A span:after { content: "A"; }
            .key.B span:after { content: "B"; }
            @media (max-width: 1023px) {
                .key.o5 { display: none; }
            }

            .sheet { display: flex; flex-direction: row; flex-wrap: wrap;
                align-content: flex-start; padding: 0 10px; overflow: auto; }
            .score {
                position: relative;
                height: 50px;
                margin: 18px 0;
                margin-right: -1px;
                border: 1px solid #000;
                display: flex; flex-direction: row;
            }
            .score:first-child { border-left-width: 4px; }
            .score:last-child { border-right-width: 4px; }
            .score:before { content: ""; position: absolute;
                top: 25%; bottom: 25%; left: 0; right: 0;
                border: 1px solid #000; border-left: none; border-right: none;
            }
            .score:after { content: ""; position: absolute; top: 50%;
                left: 0; right: 0; border-top: 1px solid #000;
            }
            .score > note { flex: 1 100%; }
            note { font-size: 70px; font-family: FreeSerif; position: relative; padding: 0 20px; }
            @media (max-width: 767px) {
                note { padding: 0 3vw; }
            }
            @media (max-height: 500px) {
                note { padding: 0 13px; }
            }
            .note { position: absolute; height: 100%; line-height: 100%; bottom: 0; left: 0; right: 0; z-index: 999; }
            .note:after { position: absolute; height: 200%; line-height: 200%; bottom: 0; left: 0; right: 0; text-align: center; }
            .note.t8:after { content: "\266A"; } /* eight note */
            .note.t4:after { content: "\2669"; } /* quarter note */
            .note.t2:after { content: "\1d15e"; } /* half note */
            .note.clef:after { content: "\1d11e"; font-size: 80%; bottom: -30%; }
            .note.C4 { bottom: -50%; }
            .note.D4 { bottom: -37%; }
            .note.E4 { bottom: -25%; }
            .note.F4 { bottom: -13%; }
            .note.G4 { bottom: 0; }
            .note.A4 { bottom: 13%; }
            .note.B4 { bottom: -25%; transform: rotate(180deg); }
            .note.C5 { bottom: -13%; transform: rotate(180deg); }
            .note.D5 { bottom: 0; transform: rotate(180deg); }
            .note.E5 { bottom: 13%; transform: rotate(180deg); }
            .note.F5 { bottom: 25%; transform: rotate(180deg); }
            .note.G5 { bottom: 37%; transform: rotate(180deg); }

            /* color schemes */
            .settings .color-select .color-basic { background: #1b67cf; }
            .color-basic .key span { color: #fff; }
            .color-basic .key.C { background: #1b67cf; }
            .color-basic .note.C { color: #1b67cf; }
            .color-basic .key.D { background: #edea15; }
            .color-basic .note.D { color: #edea15; }
            .color-basic .key.E { background: #ea2525; }
            .color-basic .note.E { color: #ea2525; }
            .color-basic .key.F { background: #eee; }
            .color-basic .key.F span { color: #333; }
            .color-basic .note.F { color: #aaa; }
            .color-basic .key.G { background: #269428; }
            .color-basic .note.G { color: #269428; }
            .color-basic .key.A { background: #ef7320; }
            .color-basic .note.A { color: #ef7320; }
            .color-basic .key.B { background: #7f5d82; }
            .color-basic .note.B { color: #7f5d82; }
        </style>
    </head>
    <body>
        <div id="root"></div>
    </body>
</html>
